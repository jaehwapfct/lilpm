---
name: Root Cause Analysis
description: 근원적 문제 해결 사고. 현재 방법이 최선인지 항상 의심하고, 증상이 아닌 원인을 해결. 버그 수정, 아키텍처 결정, 기술 선택 시 즉시 사용.
---

# Root Cause Analysis Skill

## 핵심 원칙

> **"증상을 치료하지 말고, 원인을 해결하라"**
> 
> 모든 문제에 대해 3가지 질문:
> 1. **What** — 실제로 무엇이 잘못되었는가?
> 2. **Why** — 왜 이 문제가 발생했는가? (5 Whys)
> 3. **How** — 이 해결법이 정말 최선인가?

## 5 Whys 기법

### 적용 예시
```
문제: "Not authenticated" 에러 발생

Why 1: 왜 인증 에러가 나는가?
  → Supabase 세션이 만료됨

Why 2: 왜 세션이 만료되었는가?
  → authStore의 캐시된 상태를 사용하고 있어서 실제 세션과 불일치

Why 3: 왜 authStore와 실제 세션이 불일치하는가?
  → 세션 갱신 이벤트 리스너가 모든 경우를 커버하지 못함

Why 4: 왜 리스너가 불완전한가?
  → onAuthStateChange가 네트워크 재연결 시 누락됨

Why 5: 왜 네트워크 재연결을 처리 안 하는가?
  → 초기 설계에서 고려 안 됨

→ 근본 해결: authStore 대신 supabase.auth.getUser() 직접 호출 패턴 적용
→ 증상 해결 (나쁜 예): try-catch로 에러 무시
```

## 대안 평가 프레임워크

### Decision Matrix
모든 중요한 기술 결정에 대해:

```
| 기준          | 방법 A | 방법 B | 방법 C |
|---------------|--------|--------|--------|
| 복잡도        | 1-5    | 1-5    | 1-5    |
| 유지보수성    | 1-5    | 1-5    | 1-5    |
| 성능          | 1-5    | 1-5    | 1-5    |
| 기존 패턴 일치 | 1-5   | 1-5    | 1-5    |
| 확장성        | 1-5    | 1-5    | 1-5    |
| 합계          |        |        |        |
```

### "최선인가?" 체크리스트

#### 코드 변경 시
- [ ] 이 변경이 증상이 아닌 원인을 해결하는가?
- [ ] 더 간단한 방법이 없는가?
- [ ] 이미 프로젝트에 비슷한 패턴이 있는가?
- [ ] 다른 곳에서 같은 문제가 발생할 가능성은?
- [ ] 이 변경이 새로운 문제를 만들 수 있는가?

#### 아키텍처 결정 시
- [ ] 현재 규모에 적합한가? (오버엔지니어링 방지)
- [ ] 6개월 후에도 유효한 결정인가?
- [ ] 팀원이 쉽게 이해할 수 있는가?
- [ ] 롤백이 가능한가?

#### 기술 선택 시
- [ ] 기존 스택과 호환되는가?
- [ ] 커뮤니티 지원/문서가 충분한가?
- [ ] 라이센스 문제는 없는가?
- [ ] 번들 사이즈 영향은?

## 문제 유형별 분석 패턴

### Type 1: 런타임 에러
```
1. 에러 메시지 → 스택 트레이스 역추적
2. 재현 조건 특정
3. 최근 변경사항 확인 (git log)
4. 가설 수립 → 검증 (console.log / debugger)
5. 근본 원인 → 수정 → 회귀 테스트
```

### Type 2: 성능 문제
```
1. 측정 (Performance 탭 / Vitest bench)
2. 병목 특정 (렌더링? 네트워크? DB?)
3. 프로파일링
4. 최적화 적용 (가장 큰 영향부터)
5. 재측정 → 비교
```

### Type 3: 설계 결함
```
1. 현재 설계의 한계 명시
2. 이상적 설계 스케치
3. 마이그레이션 비용 산정
4. 점진적 리팩토링 계획
5. 하위 호환성 유지하며 전환
```

### Type 4: 반복되는 버그
```
1. 버그 발생 패턴 분석
2. 공통 원인 추출
3. 시스템 레벨 해결 (코딩 규칙, 타입 강화, 테스트 추가)
4. 방지책 문서화
```

## LilPM 프로젝트 특화 패턴

### Supabase Auth 문제
```
근본 원인: authStore와 실제 세션 불일치
해결 패턴: supabase.auth.getUser() 직접 호출
적용 위치: 모든 인증 필요 API 호출 전
```

### FK 제약조건 에러
```
근본 원인: 새 테이블 추가 시 delete-users 함수 미업데이트
해결 패턴: 
  1. user_id → CASCADE
  2. created_by/assigned_to → SET NULL
  3. delete-users 함수에 테이블 추가
체크: 마이그레이션 생성 시 자동으로 확인
```

### 실시간 동기화 문제
```
근본 원인: Yjs CRDT 충돌 또는 WebSocket 연결 끊김
해결 패턴:
  1. y-indexeddb로 로컬 상태 유지
  2. 재연결 시 자동 동기화
  3. 충돌 시 CRDT 알고리즘이 자동 해결
체크: Cloudflare Durable Object 상태 확인
```

### RLS 정책 문제
```
근본 원인: 정책 조건이 실제 사용 케이스를 커버하지 못함
해결 패턴:
  1. pg_policies에서 현재 정책 확인
  2. 실제 사용 시나리오 나열
  3. 각 시나리오에 대해 정책 테스트
  4. 누락된 조건 추가
```

## 사고 템플릿

### 문제 발생 시
```markdown
## 문제 분석

### 증상
[관찰된 현상]

### 5 Whys
1. Why: 
2. Why: 
3. Why: 
4. Why: 
5. Why: 

### 근본 원인
[특정된 근본 원인]

### 해결 방안
| 방안 | 장점 | 단점 | 선택? |
|------|------|------|-------|
| A    |      |      |       |
| B    |      |      |       |

### 선택 근거
[왜 이 방안이 최선인지]

### 예방 대책
[같은 문제가 재발하지 않도록]
```
