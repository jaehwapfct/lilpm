name: Deploy All (Vercel + Supabase)

on:
  push:
    branches: [main, develop]
  workflow_dispatch:  # Manual trigger option
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - development

env:
  # Determine environment based on branch or manual input
  DEPLOY_ENV: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'development') }}

jobs:
  # Step 1: Build & Test
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build
        env:
          # Use different Supabase config based on environment
          VITE_SUPABASE_URL: ${{ env.DEPLOY_ENV == 'production' && secrets.VITE_SUPABASE_URL || secrets.VITE_SUPABASE_URL_DEV }}
          VITE_SUPABASE_ANON_KEY: ${{ env.DEPLOY_ENV == 'production' && secrets.VITE_SUPABASE_ANON_KEY || secrets.VITE_SUPABASE_ANON_KEY_DEV }}

  # Step 2: Deploy Vercel
  deploy-vercel:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm i -g vercel

      - name: Pull Vercel environment
        run: |
          if [ "$DEPLOY_ENV" = "production" ]; then
            vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
          else
            vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
          fi
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          DEPLOY_ENV: ${{ env.DEPLOY_ENV }}

      - name: Deploy to Vercel (Production)
        if: env.DEPLOY_ENV == 'production'
        run: vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy to Vercel (Preview/Development)
        if: env.DEPLOY_ENV == 'development'
        run: vercel deploy --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # Step 3: Deploy Supabase Edge Functions
  deploy-supabase:
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Set Supabase Project Ref
        id: set-ref
        run: |
          if [ "$DEPLOY_ENV" = "production" ]; then
            echo "PROJECT_REF=${{ secrets.SUPABASE_PROJECT_REF }}" >> $GITHUB_OUTPUT
          else
            echo "PROJECT_REF=${{ secrets.SUPABASE_PROJECT_REF_DEV }}" >> $GITHUB_OUTPUT
          fi
        env:
          DEPLOY_ENV: ${{ env.DEPLOY_ENV }}

      - name: Deploy Edge Functions
        run: |
          supabase functions deploy lily-chat --no-verify-jwt --project-ref ${{ steps.set-ref.outputs.PROJECT_REF }}
          supabase functions deploy mcp-proxy --no-verify-jwt --project-ref ${{ steps.set-ref.outputs.PROJECT_REF }}
          supabase functions deploy send-team-invite --no-verify-jwt --project-ref ${{ steps.set-ref.outputs.PROJECT_REF }}
          supabase functions deploy get-invite-preview --no-verify-jwt --project-ref ${{ steps.set-ref.outputs.PROJECT_REF }}
          supabase functions deploy send-mention-email --no-verify-jwt --project-ref ${{ steps.set-ref.outputs.PROJECT_REF }}
          supabase functions deploy send-notification-email --no-verify-jwt --project-ref ${{ steps.set-ref.outputs.PROJECT_REF }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

  # Step 4: Deploy Cloudflare Worker (Real-time Collaboration) - Production Only
  deploy-cloudflare-worker:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'  # Only deploy on main branch
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Worker Dependencies
        working-directory: workers/collab
        run: npm ci

      - name: Deploy Cloudflare Worker
        working-directory: workers/collab
        run: npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
